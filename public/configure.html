<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>HentaiStream Configuration</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" type="image/png" href="/logo.png">
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --bg:#0A0F1C;
    --card:#161737;
    --fg:#EEF1F7;
    --muted:#5F67AD;
    --preview:#5A5F8F;
    --box:#0E0B1F;
    --primary:#3926A6;
    --primary-hover:#5a42d6;
    --border:rgba(255,255,255,.08);
    --shadow:0 28px 96px rgba(0,0,0,.46);
    --radius:26px;
    --ctl-h:50px;
    --pill-h: var(--ctl-h);
    --pill-gap:10px;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;}
  .wrap{max-width:1100px;margin:56px auto;padding:0 32px;}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:48px;}
  h1{font-weight:800;font-size:38px;letter-spacing:.2px;margin:0 0 8px;text-align:center;}
  .subtle{color:var(--muted);text-align:center;margin:-2px 0 34px;}
  .warning-badge{display:inline-block;background:var(--primary);color:white;padding:4px 12px;border-radius:20px;font-size:12px;}
  .columns{display:grid;grid-template-columns:1fr 1fr;gap:56px;align-items:start}
  @media (max-width: 1080px){ .columns{grid-template-columns:1fr;gap:28px} }
  .stack{display:grid;grid-template-columns:1fr;row-gap:22px}
  .full-width{grid-column:1/-1}
  label{display:block;font-weight:600;font-size:15px;margin:0 0 8px;}
  .section-title{font-weight:600;font-size:15px;margin:2px 0 8px;}
  .control{width:100%;background:var(--box);color:var(--fg);border:1px solid transparent;border-radius:16px;padding:0 16px;height:var(--ctl-h);line-height:calc(var(--ctl-h) - 2px);outline:none;}
  .control:focus{box-shadow:0 0 0 2px rgba(57,38,166,.35);border-color:var(--primary)}
  select.control{appearance:none;background-image:linear-gradient(45deg,transparent 50%, var(--preview) 50%),linear-gradient(135deg, var(--preview) 50%, transparent 50%);background-position:calc(100% - 16px) 50%, calc(100% - 11px) 50%;background-size:6px 6px,6px 6px;background-repeat:no-repeat;padding-right:44px}
  .help{color:var(--muted);font-size:13px;margin-top:8px;line-height:1.45}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border-radius:18px;border:2px solid transparent;padding:14px 18px;min-width:220px;cursor:pointer;text-decoration:none;color:var(--fg);transition:transform .05s ease, box-shadow .2s ease, background .2s ease, border .2s ease;}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:var(--primary);border-color:var(--primary)}
  .btn-primary:hover{box-shadow:0 12px 38px rgba(57,38,166,.35);background:var(--primary-hover)}
  .btn-outline{background:transparent;border-color:var(--primary);color:var(--fg)}
  .btn-outline:hover{background:rgba(57,38,166,.08)}
  .btn-sm{min-width:auto;padding:8px 14px;border-radius:12px;border-width:1px;height:40px}
  .toggle-box{display:flex;align-items:center;gap:12px;background:var(--box);border:1px solid transparent;border-radius:16px;padding:12px 16px;height:var(--ctl-h);cursor:pointer;user-select:none;transition:all 0.2s ease}
  .toggle-box:hover{border-color:rgba(57,38,166,.3)}
  .toggle-box input{transform:scale(1.1);accent-color:var(--primary)}
  .toggle-box .label{font-weight:600}
  .blacklist-controls{display:grid;grid-template-columns:1fr auto auto;gap:var(--pill-gap);align-items:center}
  .blacklist-grid{display:grid;gap:var(--pill-gap);margin-top:10px;min-height:calc(var(--pill-h) + var(--pill-gap))}
  .blacklist-grid.one{grid-template-columns:repeat(2, 1fr)}
  .blacklist-grid.two{grid-template-columns:repeat(3, 1fr)}
  @media (max-width: 640px){ .blacklist-grid.one, .blacklist-grid.two{grid-template-columns:1fr} }
  .pill{display:flex;align-items:center;background:var(--box);border:1px solid transparent;border-radius:16px;height:var(--pill-h);padding:0 12px;width:100%;overflow:hidden;animation:fadeIn 0.3s ease-out}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .pill .txt{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
  .pill .handle{opacity:.8;cursor:pointer;font-size:16px;color:var(--muted);border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease;margin-left:auto}
  .pill .handle:hover{background:rgba(57,38,166,0.15);transform:scale(1.1)}
  .buttons{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:32px}
  @media (max-width: 720px){ .buttons{grid-template-columns:1fr} }
  code.inline{background:var(--box);border:1px solid transparent;padding:6px 12px;border-radius:8px;font-size:12px;color:var(--preview);display:block;word-break:break-all;line-height:1.4;min-height:calc(2 * 1.4em);white-space:pre-wrap;overflow-wrap:anywhere}
  .footline{display:flex;justify-content:space-between;align-items:flex-start;gap:var(--pill-gap);flex-wrap:wrap;margin-top:16px}
  .manifest-container{flex: 1;min-width:0}
  .manifest-label{color:var(--muted);font-size:14px;margin-bottom:8px;font-weight:500}
  .hidden{display:none !important}
  
  .empty-state{display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:14px;background:var(--box);border:1px solid transparent;border-radius:16px;height:var(--pill-h);padding:0 12px;width:100%}
  /* Loading spinner */
  .loading{display:flex;align-items:center;justify-content:center;padding:20px;color:var(--muted)}
  .loading::after{content:'';width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite;margin-left:10px}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>HentaiStream</h1>
      <p class="subtle">Configure your addon settings <span class="warning-badge">18+</span></p>

      <div class="columns">
        <!-- LEFT COLUMN: Genre Blacklist -->
        <div class="stack">
          <div>
            <label>Blacklist Genres</label>
            <div class="blacklist-controls">
              <select id="genrePicker" class="control">
                <option value="">Select genre to exclude...</option>
              </select>
              <button class="btn btn-sm btn-outline" id="genreAdd" type="button">Add</button>
              <button class="btn btn-sm btn-outline" id="genreClear" type="button">Clear</button>
            </div>
            <div class="help">Series with these genres will be hidden from all catalogs. <span style="color:var(--muted)">(Max 20)</span></div>
            <div id="genrePills" class="blacklist-grid one"></div>
          </div>
        </div>

        <!-- RIGHT COLUMN: Studio Blacklist -->
        <div class="stack">
          <div>
            <label>Blacklist Studios</label>
            <div class="blacklist-controls">
              <select id="studioPicker" class="control">
                <option value="">Select studio to exclude...</option>
              </select>
              <button class="btn btn-sm btn-outline" id="studioAdd" type="button">Add</button>
              <button class="btn btn-sm btn-outline" id="studioClear" type="button">Clear</button>
            </div>
            <div class="help">Series from these studios will be hidden from all catalogs. <span style="color:var(--muted)">(Max 20)</span></div>
            <div id="studioPills" class="blacklist-grid one"></div>
          </div>
        </div>
      </div>

      <!-- Display Settings - Full Width Below -->
      <div style="margin-top:22px">
        <div class="section-title">Display Settings</div>
        <div id="toggleShowCounts" class="toggle-box" role="button" tabindex="0" aria-pressed="true">
          <input id="showCounts" type="checkbox" checked />
          <div class="label">Show counts on filter options</div>
        </div>
        <div class="help">When enabled, genres, studios, and years will show item counts like "Action (125)". Disable for cleaner display.</div>
      </div>

      <div class="buttons">
        <a id="installApp" class="btn btn-primary" style="width:100%">Install to Stremio</a>
        <a id="installWeb" class="btn btn-outline" style="width:100%">Install to Web</a>
      </div>

      <div class="footline">
        <div class="manifest-container">
          <div class="manifest-label">Manifest URL:</div>
          <code id="manifestUrl" class="inline"></code>
        </div>
      </div>
    </div>

    <div style="text-align:center;margin-top:24px;color:var(--muted);font-size:13px">
      HentaiStream v0.2.0 • Aggregates content from HentaiMama, HentaiSea, and HentaiTV
    </div>
  </div>

  <script>
  (function(){
    'use strict';
    
    const MAX_BLACKLIST = 20;
    const originHost = window.location.origin;
    
    // State
    const state = {
      blacklistGenres: [],
      blacklistStudios: [],
      showCounts: true
    };
    
    // Load from localStorage
    try { 
      const saved = JSON.parse(localStorage.getItem('hentaistream_config') || '{}');
      Object.assign(state, saved);
    } catch {}
    
    // Load from URL parameters (for existing installations)
    function loadFromURL() {
      const params = new URLSearchParams(window.location.search);
      
      // Also check path-based config
      const pathMatch = window.location.pathname.match(/^\/([^/]+)\/manifest\.json/);
      if (pathMatch) {
        const configStr = decodeURIComponent(pathMatch[1]);
        configStr.split('&').forEach(part => {
          const [key, value] = part.split('=');
          if (key === 'bg' && value) {
            state.blacklistGenres = value.split(',').map(s => s.trim());
          }
          if (key === 'bs' && value) {
            state.blacklistStudios = value.split(',').map(s => s.trim());
          }
          if (key === 'showCounts') {
            state.showCounts = value !== '0';
          }
        });
      }
      
      // Query params
      if (params.get('bg')) {
        state.blacklistGenres = params.get('bg').split(',').map(s => s.trim());
      }
      if (params.get('bs')) {
        state.blacklistStudios = params.get('bs').split(',').map(s => s.trim());
      }
      if (params.get('showCounts')) {
        state.showCounts = params.get('showCounts') !== '0';
      }
    }
    
    loadFromURL();
    
    // DOM elements
    const $ = sel => document.querySelector(sel);
    const genrePickerEl = $('#genrePicker');
    const genreAddEl = $('#genreAdd');
    const genreClearEl = $('#genreClear');
    const genrePillsEl = $('#genrePills');
    const studioPickerEl = $('#studioPicker');
    const studioAddEl = $('#studioAdd');
    const studioClearEl = $('#studioClear');
    const studioPillsEl = $('#studioPills');
    const showCountsEl = $('#showCounts');
    const manifestEl = $('#manifestUrl');
    const appBtn = $('#installApp');
    const webBtn = $('#installWeb');
    
    // Hydrate toggle from state
    showCountsEl.checked = state.showCounts !== false;
    
    // Options data (fetched from server)
    let genreOptions = [];
    let studioOptions = [];
    
    function persist() {
      localStorage.setItem('hentaistream_config', JSON.stringify(state));
    }
    
    // Fetch options from server
    async function fetchOptions() {
      try {
        const response = await fetch('/api/options');
        const data = await response.json();
        
        // Use clean versions for display in dropdowns
        genreOptions = data.genres || [];
        studioOptions = data.studios || [];
        
        populateSelect(genrePickerEl, genreOptions, 'Select genre to exclude...');
        populateSelect(studioPickerEl, studioOptions, 'Select studio to exclude...');
        
        // Re-render pills with updated options
        renderGenrePills();
        renderStudioPills();
      } catch (error) {
        console.error('Failed to fetch options:', error);
        genrePickerEl.innerHTML = '<option value="">Failed to load genres</option>';
        studioPickerEl.innerHTML = '<option value="">Failed to load studios</option>';
      }
    }
    
    function populateSelect(selectEl, options, placeholder) {
      // For dropdown, show clean names (without counts) for cleaner UI
      const cleanOptions = options.map(opt => {
        // Remove count suffix like " (125)"
        return opt.replace(/\s*\(\d+\)$/, '').trim();
      });
      
      // Deduplicate
      const unique = [...new Set(cleanOptions)].sort();
      
      selectEl.innerHTML = `<option value="">${placeholder}</option>` +
        unique.map(opt => `<option value="${opt.toLowerCase()}">${opt}</option>`).join('');
    }
    
    function renderGenrePills() {
      genrePillsEl.innerHTML = '';
      const count = state.blacklistGenres.length;
      genrePillsEl.classList.toggle('one', count <= 4);
      genrePillsEl.classList.toggle('two', count > 4);
      
      const atCap = count >= MAX_BLACKLIST;
      if (atCap) {
        genreAddEl.classList.add('disabled');
        genreAddEl.setAttribute('disabled', 'disabled');
      } else {
        genreAddEl.classList.remove('disabled');
        genreAddEl.removeAttribute('disabled');
      }
      
      if (count === 0) {
        genrePillsEl.innerHTML = '<div class="empty-state">No genres blacklisted</div>';
        return;
      }
      
      state.blacklistGenres.forEach((genre, idx) => {
        const pill = document.createElement('div');
        pill.className = 'pill';
        // Format display name: capitalize first letter
        const displayName = genre.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        pill.innerHTML = `
          <div class="txt">${displayName}</div>
          <div class="handle" onclick="removeGenre(${idx})" title="Remove ${displayName}">✕</div>
        `;
        genrePillsEl.appendChild(pill);
      });
    }
    
    function renderStudioPills() {
      studioPillsEl.innerHTML = '';
      const count = state.blacklistStudios.length;
      studioPillsEl.classList.toggle('one', count <= 4);
      studioPillsEl.classList.toggle('two', count > 4);
      
      const atCap = count >= MAX_BLACKLIST;
      if (atCap) {
        studioAddEl.classList.add('disabled');
        studioAddEl.setAttribute('disabled', 'disabled');
      } else {
        studioAddEl.classList.remove('disabled');
        studioAddEl.removeAttribute('disabled');
      }
      
      if (count === 0) {
        studioPillsEl.innerHTML = '<div class="empty-state">No studios blacklisted</div>';
        return;
      }
      
      state.blacklistStudios.forEach((studio, idx) => {
        const pill = document.createElement('div');
        pill.className = 'pill';
        // Format display name: capitalize each word
        const displayName = studio.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        pill.innerHTML = `
          <div class="txt">${displayName}</div>
          <div class="handle" onclick="removeStudio(${idx})" title="Remove ${displayName}">✕</div>
        `;
        studioPillsEl.appendChild(pill);
      });
    }
    
    // Global remove functions
    window.removeGenre = function(idx) {
      state.blacklistGenres.splice(idx, 1);
      persist();
      renderGenrePills();
      rerender();
    };
    
    window.removeStudio = function(idx) {
      state.blacklistStudios.splice(idx, 1);
      persist();
      renderStudioPills();
      rerender();
    };
    
    // Event handlers
    genreAddEl.onclick = () => {
      if (state.blacklistGenres.length >= MAX_BLACKLIST) return;
      const value = genrePickerEl.value.trim();
      if (value && !state.blacklistGenres.includes(value)) {
        state.blacklistGenres.push(value);
        genrePickerEl.value = '';
        persist();
        renderGenrePills();
        rerender();
      }
    };
    
    genreClearEl.onclick = () => {
      state.blacklistGenres = [];
      persist();
      renderGenrePills();
      rerender();
    };
    
    studioAddEl.onclick = () => {
      if (state.blacklistStudios.length >= MAX_BLACKLIST) return;
      const value = studioPickerEl.value.trim();
      if (value && !state.blacklistStudios.includes(value)) {
        state.blacklistStudios.push(value);
        studioPickerEl.value = '';
        persist();
        renderStudioPills();
        rerender();
      }
    };
    
    studioClearEl.onclick = () => {
      state.blacklistStudios = [];
      persist();
      renderStudioPills();
      rerender();
    };
    
    showCountsEl.onchange = () => {
      state.showCounts = showCountsEl.checked;
      persist();
      rerender();
    };
    
    // Wire toggle box click
    function wireToggle(boxId, inputEl) {
      const box = document.getElementById(boxId);
      if (!box) return;
      const updateAria = () => box.setAttribute('aria-pressed', inputEl.checked ? 'true' : 'false');
      box.addEventListener('click', (e) => {
        if (e.target === inputEl) return;
        inputEl.checked = !inputEl.checked;
        inputEl.dispatchEvent(new Event('change'));
        updateAria();
      });
      box.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          inputEl.checked = !inputEl.checked;
          inputEl.dispatchEvent(new Event('change'));
          updateAria();
        }
      });
      updateAria();
    }
    wireToggle('toggleShowCounts', showCountsEl);
    
    // Build config URL
    function buildConfigPath() {
      const parts = [];
      
      if (state.blacklistGenres.length > 0) {
        parts.push(`bg=${state.blacklistGenres.join(',')}`);
      }
      
      if (state.blacklistStudios.length > 0) {
        parts.push(`bs=${state.blacklistStudios.join(',')}`);
      }
      
      if (!state.showCounts) {
        parts.push('showCounts=0');
      }
      
      return parts.join('&');
    }
    
    function rerender() {
      const configPath = buildConfigPath();
      let manifestUrl;
      
      if (configPath) {
        manifestUrl = `${originHost}/${configPath}/manifest.json`;
      } else {
        manifestUrl = `${originHost}/manifest.json`;
      }
      
      // Display URL without protocol
      const displayUrl = manifestUrl.replace(/^https?:\/\//, '');
      manifestEl.textContent = displayUrl;
      
      // Install links
      if (configPath) {
        appBtn.href = `stremio://${window.location.host}/${configPath}/manifest.json`;
      } else {
        appBtn.href = `stremio://${window.location.host}/manifest.json`;
      }
      webBtn.href = `https://web.stremio.com/#/addons?addon=${encodeURIComponent(manifestUrl)}`;
    }
    
    // Initialize
    fetchOptions();
    renderGenrePills();
    renderStudioPills();
    rerender();
  })();
  </script>
</body>
</html>
